import r from"mysql2/promise";import{exec as e}from"child_process";import{promisify as t}from"util";import o from"fs";import c from"path";t(e);let s=e=>r.createPool({host:e.host,user:e.user,password:e.password,database:e.database,port:e.port||3306,waitForConnections:!0,connectionLimit:e.connectionLimit||10,queueLimit:0}),a=async(r,e,t=[])=>{try{let[o]=await r.execute(e,t);return{success:!0,data:o,error:void 0}}catch(r){return console.error("쿼리 실행 실패:",r),{success:!1,data:void 0,error:r instanceof Error?r:Error(r instanceof Error?r.message:"알 수 없는 오류가 발생했습니다.")}}},i=async(r,e)=>{try{await r.beginTransaction();let t=[];try{for(let o of e){let[e]=await r.execute(o.query,o.params||[]);t.push(e)}return await r.commit(),{success:!0,data:t}}catch(e){throw await r.rollback(),e}}catch(r){return{success:!1,error:r}}},n=async(r,e)=>{try{let t=c.dirname(e);o.existsSync(t)||o.mkdirSync(t,{recursive:!0});let[s]=await r.execute("SHOW TABLES"),a={};for(let e of s){let t=Object.values(e)[0],[o]=await r.execute(`SELECT * FROM ${t}`);a[t]=o}return o.writeFileSync(e,JSON.stringify(a,null,2)),{success:!0}}catch(r){return console.error("백업 실행 중 오류:",r),{success:!1,error:r}}},u=async(r,e)=>{try{if(!o.existsSync(e))return console.error("백업 파일을 찾을 수 없습니다:",e),{success:!1,error:Error("백업 파일을 찾을 수 없습니다.")};let t=JSON.parse(o.readFileSync(e,"utf-8"));await r.beginTransaction();try{for(let[e,o]of Object.entries(t))if(Array.isArray(o)&&o.length>0){let t=Object.keys(o[0]),c=t.map(()=>"?").join(","),s=`INSERT INTO ${e} (${t.join(",")}) VALUES (${c})`;for(let e of o)await r.execute(s,Object.values(e))}return await r.commit(),{success:!0}}catch(e){throw await r.rollback(),e}}catch(r){return console.error("복원 실행 중 오류:",r),{success:!1,error:r}}};export{s as createPool,a as executeQuery,i as executeTransaction,n as backup,u as restore};