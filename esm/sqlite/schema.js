function e(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}import{Database as t}from"sqlite3";import{open as a}from"sqlite";export class SqliteSchemaManager{async init(){this.db=await a({filename:this.filePath,driver:t})}async close(){this.db&&await this.db.close()}async findTables(e){try{let t=`
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name NOT LIKE 'sqlite_%'
      `,a=await this.db.all(t);if(e){let t=new RegExp(e);return a.filter(e=>t.test(e.name)).map(e=>e.name)}return a.map(e=>e.name)}catch(e){return console.error("SQLite 테이블 목록 조회 중 오류:",e),[]}}async removeTables(e){try{let t=await this.findTables(e),a={},r=await this.db.get("PRAGMA foreign_keys"),i=r&&1===r.foreign_keys;for(let e of(i&&await this.db.exec("PRAGMA foreign_keys = OFF"),t))try{await this.db.exec(`DROP TABLE IF EXISTS "${e}"`),a[e]=!0,console.log(`SQLite 테이블 삭제 성공: ${e}`)}catch(t){console.error(`SQLite 테이블 삭제 실패: ${e}`,t),a[e]=!1}return i&&await this.db.exec("PRAGMA foreign_keys = ON"),a}catch(e){throw console.error("SQLite 테이블 삭제 중 오류:",e),e}}async createTable(e){try{let t=this.groupByTableName(e);for(let[e,a]of Object.entries(t)){let t=this.generateCreateTableSQL(e,a);await this.db.exec(t)}return!0}catch(e){return console.error("SQLite 테이블 생성 중 오류:",e),!1}}async extractSchema(e){try{let t=await this.db.all(`PRAGMA table_info(${e})`),a=await this.db.all(`PRAGMA foreign_key_list(${e})`),r=await this.db.all(`PRAGMA index_list(${e})`),i=[];for(let e of r)1===e.unique&&(await this.db.all(`PRAGMA index_info(${e.name})`)).forEach(e=>i.push(e.name));return t.map(t=>{let r=a.find(e=>e.from===t.name),n=1===t.pk&&"INTEGER"===t.type.toUpperCase();return{table_name:e,column_name:t.name,data_type:t.type,is_nullable:0===t.notnull,is_primary:1===t.pk,is_unique:i.includes(t.name)||1===t.pk,is_foreign:!!r,foreign_table:r?r.table:void 0,foreign_column:r?r.to:void 0,default_value:t.dflt_value,auto_increment:n,description:""}})}catch(e){return console.error("SQLite 스키마 추출 중 오류:",e),[]}}groupByTableName(e){return e.reduce((e,t)=>{let{table_name:a}=t;return e[a]||(e[a]=[]),e[a].push(t),e},{})}generateCreateTableSQL(e,t){let a=t.map(e=>this.generateColumnSQL(e)),r=t.filter(e=>e.is_primary).map(e=>e.column_name),i=t.filter(e=>e.is_foreign&&e.foreign_table&&e.foreign_column).map(e=>this.generateForeignKeySQL(e)),n=`
CREATE TABLE ${e} (
  ${a.join(",\n  ")}`;return r.length>1&&(n+=`,
  PRIMARY KEY (${r.join(", ")})`),i.length>0&&(n+=`,
  ${i.join(",\n  ")}`),n+="\n)"}generateColumnSQL(e){return[e.column_name,this.getDataTypeSQL(e),e.is_primary&&e.auto_increment&&"INTEGER"===e.data_type.toUpperCase()?"PRIMARY KEY":"",e.is_primary&&(!e.auto_increment||"INTEGER"!==e.data_type.toUpperCase())?"PRIMARY KEY":"",e.is_nullable?"":"NOT NULL",e.is_unique&&!e.is_primary?"UNIQUE":"",e.default_value?`DEFAULT ${e.default_value}`:""].filter(Boolean).join(" ")}generateForeignKeySQL(e){return`FOREIGN KEY (${e.column_name}) REFERENCES ${e.foreign_table} (${e.foreign_column})`}getDataTypeSQL(e){switch(e.data_type.toUpperCase()){case"INT":case"INTEGER":case"TINYINT":case"SMALLINT":case"MEDIUMINT":case"BIGINT":case"UNSIGNED BIG INT":case"INT2":case"INT8":return"INTEGER";case"CHARACTER":case"VARCHAR":case"VARYING CHARACTER":case"NCHAR":case"NATIVE CHARACTER":case"NVARCHAR":return e.length?`TEXT(${e.length})`:"TEXT";case"TEXT":case"CLOB":return"TEXT";case"BLOB":return"BLOB";case"REAL":case"DOUBLE":case"DOUBLE PRECISION":case"FLOAT":return"REAL";case"NUMERIC":case"DECIMAL":case"BOOLEAN":case"DATE":case"DATETIME":return"NUMERIC";default:return e.data_type}}constructor(t){e(this,"db",void 0),e(this,"filePath",void 0),this.filePath=t}}